---

- name: collect bgp peering information 
  connection: local
  gather_facts: no
  hosts:
    # 
  collections:
    - juniper.device

  vars:
    file_name: "./files/{{ inventory_hostname }}-bgp-neigbors.info"
    file_header: "BGP Peer Information For Host:"

  roles:
    - file_creation

  tasks:

    - name: get bgp neighbor information
      juniper.device.rpc:
        rpcs:
          - get-bgp-neighbor-information
        format: json
        # dest: "./files/{{ inventory_hostname }}-bgp-neigbors-raw.json"
      register: get_bgp_neighbor_information
    
    - name: bgp neighbor peer list
      set_fact:
        peer_info: "{{ get_bgp_neighbor_information.parsed_output['bgp-information'][0]['bgp-peer']}}"

    - name: parsed bgp peer info
      set_fact:
        bgp_neighbor_list: "{{ bgp_neighbor_list | default([]) + [dict(Peer_Address=item['peer-address'][0]['data'],Peer_AS=item['peer-as'][0]['data'],Local_Address=item['local-address'][0]['data'],Type=item['peer-type'][0]['data'],State=item['peer-state'][0]['data'],PeerGroup=item['peer-group'][0]['data'],BGP_RIB=item['bgp-rib'][0]['name'][0]['data'] | default([]),Export_Policy=item['bgp-option-information'][0]['export-policy'][0]['data'] | default([]),Import_Policy=item['bgp-option-information'][0]['import-policy'][0]['data'] | default([]))] }}"
      loop: "{{ peer_info | list }}"
      loop_control:
        label: "{{ item['peer-address'] }}"

    - name: get bgp summary information
      juniper.device.rpc:
        rpcs:
          - get-bgp-summary-information
        format: json
        # dest: "./files/{{ inventory_hostname }}-bgp-summary-raw.json"
      register: get_bgp_summary_information

    - name: bgp summary peer list
      set_fact:
        peer_summary_info: "{{ get_bgp_summary_information.parsed_output['bgp-information'][0]['bgp-peer'] }}"

    - name: parsed bgp summary info
      set_fact:
        bgp_summary_list: "{{ bgp_summary_list | default([]) + [dict(Elapsed_Time=item['elapsed-time'][0]['data'])] }}"
      loop: "{{ peer_summary_info | list }}"
      loop_control:
        label: "{{ item['elapsed-time'] }}"

    - name: zip bgp neighbor and summary
      set_fact:
        bgp_zipped_list: "{{ bgp_zipped_list | default([]) + [dict(PEERING_INFORMATION=item[0],BGP_Summary=item[1])] }}"
      loop: "{{ bgp_neighbor_list | zip(bgp_summary_list) | list }}"
      loop_control:
        label: "{{ item[0] }}"

    - name: get policy information
      juniper.device.command:
        command:
          - "show policy {{ item['PEERING_INFORMATION']['Export_Policy'] | default([]) }}"
        format: text
        # dest: "./files/{{ inventory_hostname }}-show-policy-raw.json"  
      loop: "{{ bgp_zipped_list | list }}"
      when: item['PEERING_INFORMATION']['Export_Policy'] != []
      register: show_policy_raw  
      ignore_errors: true    
      loop_control:
        label: "{{ item['PEERING_INFORMATION']['Export_Policy'] }}"

    - name: policy information list
      set_fact:
        show_policy_results: "{{ show_policy_raw['results'] }}"
  
    - name: policy information parsed
      set_fact:
        show_policy_parsed: "{{ show_policy_parsed | default([]) + [dict(output=item['stdout_lines'])] }}"
      loop: "{{ show_policy_results | list}}"
      when: item['stdout'] is defined
      ignore_errors: true   
      loop_control:
        label: "{{ item['ansible_loop_var'] }}"
    
    - name: zip with export
      set_fact:
        bgp_export_zipped_list: "{{ bgp_export_zipped_list | default([]) + [dict(PEERING_INFORMATION=item[0],POLICY_INFORMATION=item[1])] }}"
      loop: "{{ bgp_zipped_list | zip(show_policy_parsed) | list }}"
      # loop_control:
      #   label: "{{ item[0] }}"

    - name: Put data at the end of the txt file
      lineinfile:
        path: "{{ file_name }}"
        insertafter: EOF
        line: "-------------------------\nLocal Address+Port #: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Local_Address'] }}\nPeer Address+Port #: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Peer_Address'] }}\nPeer AS: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Peer_AS'] }}\nPeer Group: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['PeerGroup'] }}\nState: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['State'] }}\nType: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Type'] }}\nElapsed Time: {{ item['PEERING_INFORMATION']['BGP_Summary']['Elapsed_Time'] }}\nExport: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Export_Policy'] | default([]) }}\nExport Detail:\n {{ item['POLICY_INFORMATION']['output'] | default([]) }}\nImport: {{ item['PEERING_INFORMATION']['PEERING_INFORMATION']['Import_Policy'] | default([]) }}"
      loop: "{{ bgp_export_zipped_list }}"
  
    # - debug:
        # var: bgp_zipped_list
        # var: show_policy_parsed
        # var: bgp_export_zipped_list
        # var: show_policy_raw['results'][2]['parsed_output']['output'][0]['data']
        # var: bgp_zipped_list[2]['PEERING_INFORMATION']['Export_Policy']
        # msg:
        #   - "{{ bgp_zipped_list }}"
    #       - "{{ bgp_summary_list }}"
  
    # - name: display info
    #   debug:
    #     msg: 
    #       - "Local Address+Port #: {{ item['local-address'][0]['data'] }}"
    #       - "RIB: {{ item['bgp-rib'] | default([]) }}"
    #       - "BGP State: {{ item['peer-state'] }}"
    #       - "Elapsed Time: {{ item['elapsed-time'] }}"
    #   loop: "{{ neighbor_list }}"
    #   ignore_errors: true       

    # - name: Put data at the end of the txt file
    #   lineinfile:
    #     path: "{{ file_name }}"
    #     insertafter: EOF
    #     line: "-------------------------\nLocal Address+Port #: {{ item['local-address'][0]['data'] }}    Local AS: {{ item['local-as'][0]['data'] }}\nPeer Address+Port #: {{ item['peer-address'][0]['data'] }}    Peer AS: {{ item['peer-as'][0]['data'] }}\nBGP Type: {{ item['peer-type'][0]['data'] }}\nBGP State: {{ item['peer-state'][0]['data'] }}\nPeer Group: {{ item['peer-group'][0]['data']}}\nTable: {{ item['bgp-rib'][0]['name'][0]['data'] | default([]) }}\nExport Policy: {{ item['bgp-option-information'][0]['export-policy'][0]['data'] | default([]) }}\nImport Policy: {{ item['bgp-option-information'][0]['import-policy'][0]['data'] | default([]) }}"
    #   loop: "{{ neighbor_list }}"

